
# 영수증 출력

## 초기 statement 메서드
- 긴 내역 산출 루틴인 statement 메서드에 지나치게 많은 기능 존재, 대부분의 기능은 다른 두 클래스에 들어가야 한다. 
- 짧은 코드라서 에러없이 돌아가지만 모든 프로그램의 코드가 다 이런식이라면 난감하다.
- 컴파일러는 코드가 지저분하던 개의치 않지만, **코드 수정은 개발자의 몫**
- 수정할 위치를 찾기 힘들면 프로그래머가 실수할 가능성이 높아져서 버그 발생
- 복잡한 코드의 일부를 다른 기능에 똑같이 작성한다면? 해당 메서드 수정시마다 두개의 메서드를 둘 다 똑같이 수정해야 함
  - 아주 번거롭고 에러가 생길수도 있음 
- "긁어 부스럼 만들지 말라" 라는 격언을 기억하며 고치지 않다보면 나중엔 사용자 요구에 맞춰 수정하기 힘들 수 있다.
  - 이전 회사에서 원래 있던 코드를 수정하려고 할 때 부장님이 돌아가는 코드 굳이 고치지 말라고 했었는데 그 때 일이 떠올라서 씁쓸했다.🥺
> 프로그램에 기능을 추가해야 하는데 코드 구조가 조잡해서 그 기능을 추가하기 힘들다면, 우선 리팩토링을 실시해서 기능을 추가하기 쉽게 만든 후 그 기능을 추가하자.

## 첫 단계, 자체 검사 테스트 코드 작성  
- 첫 단계는 리팩토링할 코드 부분에 대한 신뢰도 높은 **각종 테스트를 작성**하는 것
  - 테스트는 반드시 **자체검사**로 만들어야 한다. 
  - 테스트하면 나중에 프로그램 수정할 때 필요한 안전성이 확보되므로 테스트를 작성하는 시간은 조금도 아깝지 않다(라고 말하셨다.)
> 리팩토링하기 전에 반드시 **신뢰도 높은 테스트 스위트**가 준비됐는지 확인하자. 이 테스트들은 반드시 **자체검사**가 되게 작성한다.

## statement 메서드 분해와 기능 재분배
- 너무 긴 메서드를 보면 작은 부분들로 쪼갤 수 있는지 살펴보자. 
- 긴 메서드를 분해해서 각 부분을 알맞은 클래스로 옮기자. 
- 메서드 추출 기법
  - 잘못된 메서드 추출 기법은 버그가 발생할 수 있으니 문제없이 추출할 방법부터 찾아둬야 함 
  - switch 문은 하나의 메서드로 빼는 것이 적절한 덩어리임
  - 메서드 내부에서만 효력이 있는 모든 지역변수-매개변수에 해당하는 부분 살펴보기 
    - **변경되지 않는 변수는 매개변수로 전달 가능**
    - 변경가능 변수는 주의 필요: 변경 변수가 하나라면 리턴 가능
- 수정시마다 컴파일과 테스트 실시 
- 각 단계의 수정은 사소하기에 어떠한 에러든 찾기가 매우 쉽다. 
> 리팩토링은 프로그램을 **조금씩 단계적**으로 수정하므로 실수해도 버그를 찾기가 쉽다. 
- 좋은 코드는 그것이 무슨 기능을 하는지 분명히 드러나야 하는데, **코드의 기능을 분명히 드러내는 열쇠가 바로 직관적인 변수명**이다.
> 컴퓨터가 인식 가능한 코드는 바보라도 작성할 수 있지만, **인간이 이해할 수 있는 코드는 실력 있는 프로그래머만 작성**할 수 있다.
- 메서드 이동 기법 : 메서드는 대체로 자신이 사용하는 데이터와 같은 객체에 들어 있어야 한다. 
  - 같은 객체에 들어가게 된다면 불필요한 매개변수도 제거한다.
  - 메서드를 이동했다면 참조했던 코드들도 알맞게 고쳐준다. `amountFor(each);` -> `each.getCharge();`
- 메서드 호출로 전환 기법: 메서드의 결과를 저장하는데만 사용되고 사용하지 않는 변수라면 사용하자.
  - 임시변수가 많으면 불필요하게 많은 매개변수를 전달하게 되는 문제가 흔히 생긴다. 
- 특정 계산코드를 메서드로 빼기
- 임시변수 없애기 
  - 자체 루틴 안에서만 효력 존재, 점점 더 많은 임시변수 사용시 코드가 복잡해진다.
- 복사해서 붙인 중복 코드가 없어 계산식 자체를 수정해야 할 때도 한 군데만 수정하면 됨

## 가격 책정 부분의 조건문을 재정의로 교체
- 타 객체의 속성을 switch 문의 인자로 하는 것은 나쁜 방법이다. / 자신의 데이터를 사용해야 한다.
  - `switch (getMovie().getPriceCode())` -> `switch(getPriceCode()`

## 마지막 단계, 상속 구조 만들기 
- Movie 클래스는 비디오 종류에 따라 같은 메서드 호출에도 각기 다른 값을 반환한다. 이건 하위 클래스가 할 일이다.
- 비디오 분류는 언제든 바뀔 수 있지만 객체는 수정이 불가능하므로 불일치가 발생한다. 상태 패턴을 적용해 switch 문을 삭제하면 된다. 
- 상태 패턴 : 상태/전략패턴으로 전환 기법 -> 메서드 이동 기법 실시 -> 조건문을 재정의로 전환 기법 
  - 상태 패턴을 적용하면 대여료 계산 방식을 변경하거나, 새 대여료를 추가하거나, 부수적인 대여료 관련 동작을 추가할 때 아주 쉽게 수정 가능
  - 프로그램의 다른 부분은 상태 패턴의 영향을 받지 않는다.

> 반복하자 : 간단한 수정 -> 테스트


## 느낀점
클린코드를 읽고서 리팩토링 책을 읽기 시작했는데 여기서도 읽으면서 뼈맞을 듯 하다.🥸

새로운 종류가 추가될때마다 기존 코드 수정이 아닌 하위 클래스를 추가하여 입맛에 맞게 변경하면 종류 추가에 대한 부담이 많이 줄어들 것 같다.

수정을 조금씩 하면서 테스트를 반복하면 왕창 수정 후 테스트가 되지 않아 어디가 틀렸는지 디버깅을 하는 불상사를 막을 수 있을 듯 하다.

재밌다. (아직까지는)
