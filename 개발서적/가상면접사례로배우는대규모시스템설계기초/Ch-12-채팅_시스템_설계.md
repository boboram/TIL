# Ch12 채팅 시스템 설계 

## 1단계. 문제 이해 및 설계 범위 확정
- 응답지연이 낮은 일대일 채팅 기능
- 최대 100명까지 참여할 수 잇는 그룹 채팅 기능
- 사용자의 접속상태 표시 기능
- 다양한 단말 지원. 하나의 계정으로 여러 단말에 동시 접속 지원
- 푸시 알림

## 2단계. 개략적 설계안 제시 및 동의 구하기 

### 서버-클라이언트 간 연결 방안 
- 폴링 : 클라이언트가 주기적으로 서버에게 새 메시지 존재 여부 요청, 서버 자원이 불필요하게 낭비 됨
- 롱 폴링 : 클라이언트는 새 메시지가 반환되거나 타임아웃 될 때까지 연결을 유지
- 웹소켓 : 비동기 메시지를 보낼 때 널리 사용하는 기술
### 개략적 설계안
- 무상태 서비스 : 기본 API 요청 방식 
- 상태유지(stateful) 서비스
  - 클라이언트는 보통 서버가 살아 있는 한 다른 서버로 연결 변경 X
- 제3자 서비스 연동 : 푸시 알림

### 데이터 모델
- `키-값 저장소`
  - 수평적 규모확장 가능
  - 데이터 접근 지연시간이 낮다.
  - 많은 채팅 시스템이 해당 저장소를 채택함
 
## 3단계. 상세 설계 

### 서비스 탐색 
- 사용자에게 알맞은 채팅 서버 연결

### 메시지 흐름
- 1:1 채팅 : 메시지 동기화 큐 사용, 1개의 동기화 큐 사용 
- 여러 단말 사이의 메시지 동기화 : 해당 단말에서 관측된 가장 최신 메시지의 ID를 추적하여 동기화 처리
- 소규모 그룹 채팅에서의 메시지 흐름 : N개의 동기화 큐 사용, 큐를 사용하면 사용자는 본인 큐만 확인하면 되기 때문에 메시지 동기화 플로우가 단순하다.

### 접속상태 표시 
- 접속상태 서버(+ 키-값 저장소)를 이용하여 사용자 로그인|로그아웃|접속장애시 접속상태를 업데이트한다.

## 4단계 마무리 
- 추가 논의하면 좋을 내용들
  - 미디어 지원 방식
  - 종단 간 암호화 : 발신인-수신인만 메시지 확인 가능하도록
  - 캐시 : 이미 읽은 메시지 캐시 처리 
  - 로딩 속도 개선 : 채널 지역 분산 등
  - 오류 처리 : 채팅 서버 오류, 메시지 재전송  
