# Ch06. 키-값 저장소 설계

## 키-값 저장소 (key-value store)
- 키-값 데이터베이스라고도 불리는 비 관계형(non-relational) 데이터베이스이다.
- 키는 짧을수록 좋다.
- 값은 문자열일 수도 있고 리스트(list)일 수도 있고 객체(object)일 수도 있다.
- 아마존 다이나모, memcached, 레디스 같은 것들이 있다.
- 종류
  - 단일 서버 키-값 저장소 : 빠른 속도를 보장하긴 하지만 모든 데이터를 메모리 안에 두는 것이 불가능할 수도 있다는 약점이 존재한다.
  - 분산 키-값 저장소 : 키-값 쌍을 여러 서버에 분산시킨다.
    - CAP(Consistency, Availability, Partition Tolerance theorem) 를 이해 하고 있어야 한다.

### CAP
- 일관성(Consistency) : 언제나 같은 데이터 제공 가능
- 가용성(Availability) : 일부 노드에 장애가 발생하더라도 항상 응답 가능
- 파티션 감내(Partition Tolerance theorem) : 파티션(두 노드 사이에 통신 장애가 발생하는 현상)이 생기더라도 계속 동작해야 함
- 서비스 요구사항에 맞도록 CAP 정리를 적용해야 한다. 

## 키-값 저장소 구현에 사용될 핵심 컴포넌트들 및 기술 
### 데이터 파티션 
- 데이터를 작은 파티션들로 분할한 다음 여러 대 서버에 저장하는 것
- 고려 사항
  - 데이터를 여러 서버에 고르게 분산할 수 있는가
  - 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화할 수 있는가
  - 안정 해시 개념 사용 : 해당 키 위치에서 시계 방향으로 가장 먼저 접근되는 서버와 연결
    - 규모 확장 자동화와 다양성의 이점이 있음

### 데이터 다중화 
- 높은 가용성과 안정성을 확보하기 위해서는 데이터를 N개 서버에 비동기적으로 다중화(replication)할 필요가 있다.
- 안정성을 담보하기 위해 데이터의 사본은 다른 센터의 서버에 보관하고, 센터들은 고속 네트워크로 연결한다.

### 데이터 일관성 
- 정족수 합의(Quorum Consensus) 프로토콜을 사용하면 R/W 연산 모두에 일관성을 보장할 수 있다.
- N : 사본 개수, W : 쓰기 연산에 대한 정족수, R : 읽기 연산에 대한 정족수
- R=1, W=N : 빠른 읽기 연산에 최적화된 시스템 (읽기가 한개만 우선적으로 완료되면 되기 때문에 읽기 연산에 최적화된 시스템)
- W=1, R=N : 빠른 쓰기 연산에 최적화된 시스템
- W+R > N : 강한 일관성이 보장됨(보통 N=3, W=R=2)
  - 강한 일관성(strong consistency) : 클라이언트는 절대로 낡은 데이터를 보지 못한다. 
- W+R <= N : 강한 일관성이 보장되지 않음
  - 약한 일관성(weak consistency) : 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
  - 결과적 일관성(eventual consistency) : 갱신 결과가 결국에는 모든 사본에 반영(즉, 동기화)되는 모델이다.
  - 비 일관성 해소 기법 : 데이터 버저닝, 벡터 시계
- 장애 처리 : 장애는 아주 흔하게 벌어지는 사건이다. 장애 감지 후 장애 처리를 한다. 
  - 장애 처리 : 느슨한 정족수 접근법, 임시 위탁 기법(임시로 쓰기 연산을 처리한 서버에 힌트를 남겨둠) 
  - 영구 장애 처리 : 반-엔트로피 프로토콜(사본 비교, 최신 버전으로 갱신) + 머클 트리(=해시 트리)    
- 데이터 센터 장애 처리 : 여러 데이터 센터에 걸친 데이터 다중화 
 
