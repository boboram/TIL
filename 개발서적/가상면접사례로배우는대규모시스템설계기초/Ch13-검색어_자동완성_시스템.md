# Ch13. 검색어 자동완성 시스템

## 1단계 문제 이해 및 설계 범위 확정 
- 요구사항
  - 빠른 응답 속도
  - 연관성 : 사용자가 입력한 단어와 연관된 것이어야 한다.
  - 정렬
  - 규모 확장성 : 많은 트래픽 감당 가능
  - 고가용성
- 개략적 규모 추정
  - DAU = 천만명
  - 한 사용자는 매일 10건 검색
  - 평균 20바이트 데이터 입력
  - 질의 가운데 20%정도는 신규 검색어

## 2단계 개략적 설계안 제시 및 동의 구하기 
- SQL 질의는 데이터 양이 적을 때는 나쁘지 않지만 데이터 양이 많아지면 데이터베이스 병목 발생 가능 
### 데이터 수집 서비스
- 사용자가 입력한 질의를 실시간으로 수집하는 시스템
### 질의 서비스
- 주어질 질의에 N 개의 인기 검색어를 정렬해 내놓는 서비스
- query: 질의문 저장 필드 / frequency: 빈도 저장 필드

## 3단계 상세 설계 
### 트라이 자료 구조 
- 문자열들을 간략하게 저장할 수 잇는 자료구조다.
- 트리 형태의 자료구조
- p: prefix / n: node / c: child
- 접두어의 최대 길이를 제한 / 노드에 인기 검색어 캐시 하는 방법을 통해 k개 결과 획득을 최적화 할 수 있다. -> 시간 복잡도 : `O(1)`

### 데이터 수집 서비스
- 데이터 분석 서비스 로그 -> 로그 취합 서버 -> 취합된 데이터 -> 작업 서버 -> (매주 갱신) -> 트라이 데이터베이스 -> (매주 데이터베이스의 상태를 스냅샷) -> 트라이 캐시
- 데이터 분석 서비스 로그 : 한 행씩 쌓이기만 함
- 로그 취합 서버 : 원하는 기간을 정하여 로그 취합
- 취합된 데이터 : 기간이 7일이면 해당 주에 쌓인 데이터 로그
  - query(질의문), time(해당 주가 시작한 날짜), frequency(해당 주에 사용된 횟수의 합)
- 작업 서버 : 트라이 자료구조를 만들고 트라이 DB에 저장하는 역할
- 트라이 캐시 : 트라이 데이터를 메모리에 유지하여 읽기 연산 성능을 높이는 구실
- 트라이 데이터베이스 : 지속성 저장소
  - 문서 저장소 : 몽고디비 같은 문서 저장소, 주기적으로 트라이를 직렬화하여 저장 가능
  - 키-값 저장소

### 질의 서비스 
- 사용자 단말(웹브라우저|모바일 앱) -> 로드밸런서 -> API 서버 -> 트라이 캐시 -> 트라이 데이터베이스
- 요청 방식 : AJAX 요청, 브라우저 캐싱, 데이터 샘플링

### 트라이 연산
- 트라이 생성, 갱신, 검색어 삭제(위험한 질의어 삭제, 필터 사용)

### 저장소 규모 확장
- 첫 글자를 기준으로 샤딩
  - 서버에 균등하게 배분하기가 불가능하기에 샤드 관리자는 어떤 검색어가 어느 저장소 서버에 저장되는지에 대한 정보를 관리한다. 
